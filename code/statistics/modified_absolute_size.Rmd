---
title: "Absolute_size"
output: html_document
date: '2022-07-04'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import libraries, message=FALSE, warning=FALSE, }
library(tidyverse)
library(knitr)
library(openxlsx)
library(stats)
library(rlist)
library(plyr)
library(ggplot2)
library(dplyr)
```

## Compute Mann-Whitney Test

```{r}
get_u_stats <- function(table, shuffle=FALSE){
  n = 0
  U_x = 0
  U_y = 0
  langs = unique(table$language)
  for (lang in langs){
    
    lang_table <- table[table$language == lang,]
    lang_table <- lang_table[!is.na(lang_table$language),]
    
    lang_table$rank <- rank(lang_table$score)
    if (shuffle == TRUE){
      shuffled_lang_table <- transform(lang_table, rank=sample(rank))
      shuffled_lang_table %>% filter(gender=="3") -> gender_3
      shuffled_lang_table %>% filter(gender=="4") -> gender_4}
    else {
      lang_table %>% filter(gender=="3") -> gender_3
      lang_table %>% filter(gender=="4") -> gender_4
    }
  

    X <- gender_3$rank
    Y <- gender_4$rank
  
    n_x <- length(X)
    n_y <- length(Y)
    R_x <- sum(X)
    R_y <- sum(Y)
    u_x = n_x * n_y + (n_x * (n_x +1))/2 - R_x
    u_y = n_x * n_y + (n_y * (n_y +1))/2 - R_y
    U_x <- U_x + u_x
    U_y <- U_y + u_y
  }
  #u_observed = min(c(U_x, U_y))
  u_observed = U_x
  return (u_observed)
               
  }
```

```{r}
grouped_mann_whitney <- function(table, data) {
    u_observed <- get_u_stats(table)
    U_list <- list()
    for (i in 1:10000){
      u <- get_u_stats(table, TRUE)
      U_list <- list.append(U_list, u)
    }
   # Us <- sort(Us, decreasing = FALSE)
    U_list <- lapply(U_list,sort,decreasing=TRUE)
    num = 0
    for (e in seq_along(U_list)){
      if (U_list[e] >= u_observed){
        num = num + 1
      }}
   # plot(U_list)
    df <- ldply (U_list, data.frame)
    colnames(df) <- c("number")
    p <- ggplot(df, aes(x=number)) + geom_density() + geom_vline(aes(xintercept=u_observed), color="blue", linetype="dashed", linewidth=1)
    ggsave(p, 
       filename = sprintf("%s.pdf", data),
       device = "pdf",
       height = 6, width = 5, units = "in")
    return (num/length(U_list))
}
```

``` {r}
count_mw <- function(table, data){
  table <- table[c("gender", "language", data)]
  colnames(table)[3] ="score"
  table <- table[!is.na(table$score),]
  
  test <- grouped_mann_whitney(table, data)
  return(test)
}
``` 


## Run code for each language

```{r  input: LIST OF NOUNS (for a given language)}

get_data <- function(words, big_concepts, small_concepts, filter_animal=FALSE){
  
  if (filter_animal == TRUE){
    big_concepts %>% filter(is.na(animal)) -> big_concepts
    small_concepts %>% filter(is.na(animal)) -> small_concepts}
  
  words <- words[!duplicated(words[c("concept","gender")]),]

  df_small <- merge(small_concepts, words, by="concept", all.x=TRUE)
  df_big <- merge(big_concepts, words, by="concept", all.x=TRUE)
  df <- rbind(df_small, df_big)
  df <- subset(df, !is.na(language))
  
  
  macabre_big_mw <- count_mw(df_big, "macabre.big")
  macabre_sm_mw <- count_mw(df_small,"macabre.small")
  binder_big_mw <- count_mw(df_big, "binder.et.al.big")
  binder_sm_mw <- count_mw(df_small, "binder.et.al.small")
  mcrae_big_mw <- count_mw(df_big, "mcrae.et.al.big")
  mcrae_sm_mw <- count_mw(df_small, "mcrae.et.al.small")
  
  results <- data.frame(
    source=c("macabre.big", "macabre.small", 
             "binder.et.al.big", "binder.et.al.small", 
             "mcrae.et.al.big", "mcrae.et.al.small"),
    pvalue=c(macabre_big_mw, macabre_sm_mw,
             binder_big_mw, binder_sm_mw, 
             mcrae_big_mw, mcrae_sm_mw)
  )
  return(list(df, results))
}
```

```{r}
languages <- list("Archi", "Budukh", "Khinalug", "Kryz", "Lak", "Rutul", "Tsakhur")

path_to_data = "../../data/absolute_size_experiment"

words = read.xlsx(file.path(path_to_data, "annotated_data", "as words.xlsx"))
words = filter(words, is.na(f.compound))

concepts = read.xlsx(file.path(path_to_data, "annotated_data", "as concepts.xlsx"))
big_concepts = filter(concepts, absolute.size=="big")
small_concepts = filter(concepts, absolute.size=="small")

joint_df <- data.frame()
mw_results <- data.frame()

output <- get_data(words, big_concepts, small_concepts)
joint_df <- rbind(joint_df, output[[1]])
mw_results <- rbind(mw_results, output[[2]])

write.xlsx(joint_df, file.path(path_to_data, "results", "as joint.xlsx"))
write.xlsx(mw_results, file.path(path_to_data, "results", "as results.xlsx"))
```
